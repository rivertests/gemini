<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>Inteligencia Titan</title>
    <style>
        :root {
            font-family: Nunito, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        body, html {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #101212;
            color: #f8fbf8;
        }
        #site-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
        #offline-container {
            display: none;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .offline-content {
            display: flex;
            background-color: #1c1d1e;
            border-radius: 12px;
            padding: 32px;
            flex-direction: column;
            gap: 24px;
            text-align: center;
            border: 1px solid #3d3f40;
            width: 100%;
            max-width: 400px;
        }
        .offline-content__titulo { margin: 0; font-size: 20px; font-weight: 700; }
        .offline-content__mensagem { margin: 0; font-size: 16px; line-height: 1.5; color: #dcdfdc; }
    </style>
</head>
<body>
    <iframe id="site-iframe" src="https://inteligenciatitan.com.br"></iframe>
    <div id="offline-container">
        <div class="offline-content">
            <h3 class="offline-content__titulo">Falha na Conexão</h3>
            <p class="offline-content__mensagem">
                Você parece estar offline. Por favor, verifique sua conexão e reinicie o aplicativo.
            </p>
        </div>
    </div>

    <script src="capacitor.js"></script>
    <script>
        // --- Sistema de Logging Remoto ---
        const LOGGING_ENDPOINT = 'https://SEU_SERVIDOR.com/path/to/log-receiver.php'; // TROQUE ESTA URL

        const logger = {
            queue: [],
            init() {
                const methods = ['log', 'warn', 'error', 'info', 'debug'];
                methods.forEach(method => {
                    const original = console[method];
                    console[method] = (...args) => {
                        this.add(method.toUpperCase(), ...args);
                        original.apply(console, args);
                    };
                });
                window.onerror = (message, source, lineno, colno, error) => {
                    console.error('Uncaught Exception:', { message, source, lineno, error: error ? error.stack : 'N/A' });
                };
                console.log('Logger inicializado.');
            },
            add(type, ...args) {
                try {
                    const message = args.map(arg => (typeof arg === 'object' ? JSON.stringify(arg) : String(arg))).join(' ');
                    this.queue.push({ timestamp: new Date().toISOString(), type, message });
                    this.saveQueue();
                } catch (e) {
                    // Evita que o logger quebre o app
                }
            },
            async saveQueue() {
                if (Capacitor && Capacitor.Plugins && Capacitor.Plugins.Preferences) {
                    await Capacitor.Plugins.Preferences.set({ key: 'app_log_queue', value: JSON.stringify(this.queue) });
                }
            },
            async sendQueue() {
                if (!Capacitor || !Capacitor.Plugins || !Capacitor.Plugins.Preferences) return;
                const { value } = await Capacitor.Plugins.Preferences.get({ key: 'app_log_queue' });
                if (!value) return;

                const logsToSend = JSON.parse(value);
                if (logsToSend.length === 0) return;

                console.log(`Enviando ${logsToSend.length} logs para o servidor...`);
                try {
                    const response = await fetch(LOGGING_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(logsToSend)
                    });
                    if (response.ok) {
                        console.log('Logs enviados com sucesso.');
                        this.queue = [];
                        await Capacitor.Plugins.Preferences.remove({ key: 'app_log_queue' });
                    } else {
                        console.error(`Falha ao enviar logs. Servidor respondeu com: ${response.status}`);
                    }
                } catch (error) {
                    console.error('Erro de rede ao enviar logs:', error);
                }
            }
        };
        logger.init();

        // --- Lógica Principal do App ---
        const iframe = document.getElementById('site-iframe');
        const offlineContainer = document.getElementById('offline-container');

        document.addEventListener('deviceready', async () => {
            console.log('Device pronto. Verificando conexão para enviar logs pendentes.');
            const { Network } = Capacitor.Plugins;
            const status = await Network.getStatus();
            if (status.connected) {
                await logger.sendQueue();
            } else {
                console.log('Offline, logs não serão enviados agora.');
            }
        });

        const timer = setTimeout(() => {
            handleLoadError();
        }, 10000);

        iframe.addEventListener('load', () => {
            clearTimeout(timer);
            console.log("Site carregado com sucesso no iframe.");
        });

        function handleLoadError() {
            console.error("Iframe não carregou em 10s. Assumindo offline.");
            iframe.style.display = 'none';
            offlineContainer.style.display = 'flex';
        }
    </script>
</body>
</html>
